<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Feel Liao">
<title>4&nbsp; 学习示例 – R语言数据可视化学习笔记</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../plot/plot_ex.html" rel="next">
<link href="../ggplot2/ggplot2extend.html" rel="prev">
<link href="../favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-cd7de1037569933fbb609f06423bd096.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../ggplot2/ggplot2chapter.html">ggplot2 高级</a></li><li class="breadcrumb-item"><a href="../ggplot2/ggplot2_spring.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">学习示例</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R语言数据可视化学习笔记</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/FeelLiao/RdataVisualization" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ChangeLog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">更新日志</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../ggplot2/ggplot2chapter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 高级</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ggplot2/ggplot2intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">ggplot2简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ggplot2/ggplot2internal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ggplot2工作原理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ggplot2/ggplot2extend.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">编写ggplot2扩展</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ggplot2/ggplot2_spring.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">学习示例</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../plot/plot_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2高级绘图示例</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plot/top50en.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Top 50 ggplot2 Visualizations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plot/top50zh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Top 50 ggplot2 可视化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plot/BasicStatisticalGraph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">基础统计绘图</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plot/NetworkRelatedGraph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">网络相关绘图</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../extension/extension_chapter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">编写 ggplot2 拓展</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../extension/gghdr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">gghdr</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../extension/introdataviz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">introdataviz</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-intuitive-spring" id="toc-sec-intuitive-spring" class="nav-link active" data-scroll-target="#sec-intuitive-spring"><span class="header-section-number">4.1</span> What is a spring?</a></li>
  <li>
<a href="#sec-spring-stat" id="toc-sec-spring-stat" class="nav-link" data-scroll-target="#sec-spring-stat"><span class="header-section-number">4.2</span> Part 1: A stat</a>
  <ul class="collapse">
<li><a href="#building-functionality" id="toc-building-functionality" class="nav-link" data-scroll-target="#building-functionality"><span class="header-section-number">4.2.1</span> Building functionality</a></li>
  <li><a href="#creating-the-stat" id="toc-creating-the-stat" class="nav-link" data-scroll-target="#creating-the-stat"><span class="header-section-number">4.2.2</span> Creating the stat</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods"><span class="header-section-number">4.2.3</span> Methods</a></li>
  <li><a href="#constructors" id="toc-constructors" class="nav-link" data-scroll-target="#constructors"><span class="header-section-number">4.2.4</span> Constructors</a></li>
  <li><a href="#testing-the-stat" id="toc-testing-the-stat" class="nav-link" data-scroll-target="#testing-the-stat"><span class="header-section-number">4.2.5</span> Testing the stat</a></li>
  <li><a href="#post-mortem" id="toc-post-mortem" class="nav-link" data-scroll-target="#post-mortem"><span class="header-section-number">4.2.6</span> Post-mortem</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring2" id="toc-sec-spring2" class="nav-link" data-scroll-target="#sec-spring2"><span class="header-section-number">4.3</span> Part 2: Adding aesthetics</a>
  <ul class="collapse">
<li><a href="#post-mortem-1" id="toc-post-mortem-1" class="nav-link" data-scroll-target="#post-mortem-1"><span class="header-section-number">4.3.1</span> Post-mortem</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring3" id="toc-sec-spring3" class="nav-link" data-scroll-target="#sec-spring3"><span class="header-section-number">4.4</span> Part 3: A geom</a>
  <ul class="collapse">
<li><a href="#geom-extensions" id="toc-geom-extensions" class="nav-link" data-scroll-target="#geom-extensions"><span class="header-section-number">4.4.1</span> Geom extensions</a></li>
  <li><a href="#creating-the-geom" id="toc-creating-the-geom" class="nav-link" data-scroll-target="#creating-the-geom"><span class="header-section-number">4.4.2</span> Creating the geom</a></li>
  <li><a href="#a-constructor" id="toc-a-constructor" class="nav-link" data-scroll-target="#a-constructor"><span class="header-section-number">4.4.3</span> A constructor</a></li>
  <li><a href="#testing-the-geom" id="toc-testing-the-geom" class="nav-link" data-scroll-target="#testing-the-geom"><span class="header-section-number">4.4.4</span> Testing the geom</a></li>
  <li><a href="#post-mortem-2" id="toc-post-mortem-2" class="nav-link" data-scroll-target="#post-mortem-2"><span class="header-section-number">4.4.5</span> Post-mortem</a></li>
  </ul>
</li>
  <li>
<a href="#an-introduction-to-grid" id="toc-an-introduction-to-grid" class="nav-link" data-scroll-target="#an-introduction-to-grid"><span class="header-section-number">4.5</span> An introduction to grid</a>
  <ul class="collapse">
<li><a href="#grobs" id="toc-grobs" class="nav-link" data-scroll-target="#grobs"><span class="header-section-number">4.5.1</span> Grobs</a></li>
  <li><a href="#viewports" id="toc-viewports" class="nav-link" data-scroll-target="#viewports"><span class="header-section-number">4.5.2</span> Viewports</a></li>
  <li><a href="#graphical-parameters" id="toc-graphical-parameters" class="nav-link" data-scroll-target="#graphical-parameters"><span class="header-section-number">4.5.3</span> Graphical parameters</a></li>
  <li><a href="#units" id="toc-units" class="nav-link" data-scroll-target="#units"><span class="header-section-number">4.5.4</span> Units</a></li>
  <li><a href="#building-grob-classes" id="toc-building-grob-classes" class="nav-link" data-scroll-target="#building-grob-classes"><span class="header-section-number">4.5.5</span> Building grob classes</a></li>
  <li><a href="#sec-tabular-grid" id="toc-sec-tabular-grid" class="nav-link" data-scroll-target="#sec-tabular-grid"><span class="header-section-number">4.5.6</span> Tabular grid</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring4" id="toc-sec-spring4" class="nav-link" data-scroll-target="#sec-spring4"><span class="header-section-number">4.6</span> Part 4: A grid grob</a>
  <ul class="collapse">
<li><a href="#the-springgrob" id="toc-the-springgrob" class="nav-link" data-scroll-target="#the-springgrob"><span class="header-section-number">4.6.1</span> The springGrob</a></li>
  <li><a href="#the-last-geomspring" id="toc-the-last-geomspring" class="nav-link" data-scroll-target="#the-last-geomspring"><span class="header-section-number">4.6.2</span> The last GeomSpring</a></li>
  <li><a href="#post-mortem-3" id="toc-post-mortem-3" class="nav-link" data-scroll-target="#post-mortem-3"><span class="header-section-number">4.6.3</span> Post-mortem</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spring5" id="toc-sec-spring5" class="nav-link" data-scroll-target="#sec-spring5"><span class="header-section-number">4.7</span> Part 5: Scales</a>
  <ul class="collapse">
<li><a href="#scaling" id="toc-scaling" class="nav-link" data-scroll-target="#scaling"><span class="header-section-number">4.7.1</span> Scaling</a></li>
  <li><a href="#draw_key_spring" id="toc-draw_key_spring" class="nav-link" data-scroll-target="#draw_key_spring"><span class="header-section-number">4.7.2</span> draw_key_spring</a></li>
  <li><a href="#post-mortem-4" id="toc-post-mortem-4" class="nav-link" data-scroll-target="#post-mortem-4"><span class="header-section-number">4.7.3</span> Post-mortem</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/FeelLiao/RdataVisualization/edit/main/ggplot2/ggplot2_spring.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/FeelLiao/RdataVisualization/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../ggplot2/ggplot2chapter.html">ggplot2 高级</a></li><li class="breadcrumb-item"><a href="../ggplot2/ggplot2_spring.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">学习示例</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-spring1" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">学习示例</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<ol type="1">
<li>本篇文章的内容来自于<a href="https://ggplot2-book.org/ext-springs">A case study</a>。</li>
<li>暂时不翻译这篇文章</li>
</ol>
</div>
</div>
</div>
<p><a href="ggplot2extend.html" class="quarto-xref"><span>Chapter 4</span></a> provided a high-level overview of creating ggplot2 extensions, building on the discussion of ggplot2 internals in <a href="ggplot2internal.html" class="quarto-xref"><span>Chapter 2</span></a>. In this chapter we’ll take that knowledge a step further, providing a deeper dive into the process of developing full-featured extensions. To do this, we’ll take a single example — building a new geom that looks like a spring — and follow it all the way through the development process.</p>
<p>This is a carefully crafted example. You’re unlikely to actually want to use springs to visualise your data, so ggplot2 doesn’t already provide a spring geom. However, springs are just complicated enough to illustrate the most important parts of the process. This makes them ideal for our purposes!</p>
<p>We’ll develop the extension in five phases:</p>
<ol type="1">
<li>We’ll start as simple as possible by using the existing <code>geom_path()</code>, pairing it with a new stat (<a href="#sec-spring-stat" class="quarto-xref"><span>Section 4.2</span></a>).</li>
<li>The new stat only allows fixed diameter and tension, so we’ll next allow these to be used as aesthetics (<a href="#sec-spring2" class="quarto-xref"><span>Section 4.3</span></a>).</li>
<li>A stat is a great place to start but has some fundamental restrictions so we’ll next convert our work to a proper geom (<a href="#sec-spring3" class="quarto-xref"><span>Section 4.4</span></a>).</li>
<li>Geoms can only use dimensions relative to the data, and can’t use absolute sizes like 2cm, so next we’ll show you how to draw the spring with grid (<a href="#sec-spring4" class="quarto-xref"><span>Section 4.6</span></a>).</li>
<li>We’ll finish up by providing a custom scale and legend to pair with the geom (<a href="#sec-spring5" class="quarto-xref"><span>Section 4.7</span></a>).</li>
</ol>
<p>Once you’ve worked your way through this chapter, we highly recommend browsing the ggplot2 source code to look at how other stats and geoms are implemented. They will often be more complicated than what you need, but they’ll give you a sense of the things you can do.</p>
<section id="sec-intuitive-spring" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="sec-intuitive-spring">
<span class="header-section-number">4.1</span> What is a spring?</h2>
<p>Developing an extension usually starts with an idea of what you want to draw. In this case, we want to draw a spring between two points, so we need some code that will draw a plausible-looking spring! There are probably many ways to do this, but one simple approach is to draw a circle while moving the “pen” in one direction. Here’s a data set that defines a circle using 100 points:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">circle</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  radians <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span>,</span>
<span>  index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"circle"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">circle</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="op">-</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_path</span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>To transform this circle into a spring that stretches along the x axis using dplyr, we might do something like this:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">spring</span> <span class="op">&lt;-</span> <span class="va">circle</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    motion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="va">motion</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"spring"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">spring</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="op">-</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_path</span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>In this case our “spring” has only looped around once – and doesn’t look much like an actual spring – but if we were to continue tracing the circle while moving along the x axis we’d end up with a spring with multiple loops. The faster we move the “pen”, the more we will stretch the spring. This gives us some insight into the two parameters that characterise our springs:</p>
<ul>
<li>The <code>diameter</code> of the spring, defined by the size of the circle.</li>
<li>The <code>tension</code> of the spring, defined by how fast we move along <code>x</code>.</li>
</ul>
<p>Although this is probably not a physically correct parameterisation of springs in the real world, it’s good enough for our purposes.</p>
<p>Now that we have a method for drawing springs, it’s worth spending a little time thinking about what a geom based on this method will require. The code we’ve written up to this point is perfectly fine for a single plot, but there are new questions to consider when creating an extension:</p>
<ul>
<li>How will we specify the diameter of a spring?</li>
<li>How do we keep the circles circular even as we change the aspect ratio of the plot?</li>
<li>Can we map diameter and tension to variables in the data?</li>
<li>Should diameter and tension be parameters that must be the same for all springs in a layer or should they be scaled aesthetics that can vary from spring to spring?</li>
<li>If we plan to distribute our spring geom to other R users, do we want to depend on the dplyr package?</li>
</ul>
<p>We’ll consider these questions as we work through the chapter.</p>
</section><section id="sec-spring-stat" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="sec-spring-stat">
<span class="header-section-number">4.2</span> Part 1: A stat</h2>
<p>Let’s start turning this idea into a ggplot2 extension. Because we’re creating an extension that draws a new ggplot2 layer, we need to decide whether the ggproto object we create should be a <code>Stat</code> or a <code>Geom</code>. Perhaps surprisingly, this decision isn’t guided by whether we want to end up with <code>geom_spring()</code> or <code>stat_spring()</code>: there are a lot of <code>Stat</code> extensions that are used via a <code>geom_*()</code> constructor. A better way to think about this decision is to consider if we can use an existing geom with transformed data. In that case we can use a <code>Stat</code> which is usually simpler to code than a <code>Geom</code>.</p>
<p>The code we wrote in the last section fits this description nicely. All we’re doing is drawing a path, but we’re circling around instead of going in a straight line. That suggests we can use a <code>Stat</code> that transforms the data and then uses <code>GeomPath</code> to take care of the actual drawing.</p>
<section id="building-functionality" class="level3" data-number="4.2.1"><h3 data-number="4.2.1" class="anchored" data-anchor-id="building-functionality">
<span class="header-section-number">4.2.1</span> Building functionality</h3>
<p>Whenever you are developing a new <code>Stat</code> a sensible strategy is to begin by writing the data transformation function, and then once it’s working incorporating it into a ggproto <code>Stat</code>. In this case, we’re going to need a <code>create_spring()</code> function that takes a start point, an end point, a diameter, and a tension. More precisely:</p>
<ul>
<li>Our start point will be defined by arguments <code>x</code> and <code>y</code>.</li>
<li>Our end point will be defined by arguments <code>xend</code> and <code>yend</code>.</li>
<li>The <code>diameter</code> argument will be used to scale the size of our circle.</li>
<li>Defining <code>tension</code> is slightly trickier. The quantity we actually want to express is “how far the spring moves relative to the size of the circles”. So we’ll define <code>tension</code> to refer to the total distance moved from the start point to the end point, divided by the size of the circles.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>
</li>
<li>We’ll also have a parameter <code>n</code> to give the number of points used per revolution, defining the visual fidelity of the spring.</li>
</ul>
<p>We can now write code for our <code>create_spring()</code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">create_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                          <span class="va">y</span>, </span>
<span>                          <span class="va">xend</span>, </span>
<span>                          <span class="va">yend</span>, </span>
<span>                          <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                          <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, </span>
<span>                          <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Validate the input arguments</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">tension</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"`tension` must be larger than zero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">diameter</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"`diameter` can not be zero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"`n` must be greater than zero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Calculate the direct length of the spring path</span></span>
<span>  <span class="va">length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xend</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">yend</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate the number of revolutions and points we need</span></span>
<span>  <span class="va">n_revolutions</span> <span class="op">&lt;-</span> <span class="va">length</span> <span class="op">/</span> <span class="op">(</span><span class="va">diameter</span> <span class="op">*</span> <span class="va">tension</span><span class="op">)</span></span>
<span>  <span class="va">n_points</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">*</span> <span class="va">n_revolutions</span></span>
<span>  </span>
<span>  <span class="co"># Calculate the sequence of radians and the x and y offset values</span></span>
<span>  <span class="va">radians</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_revolutions</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span>, length.out <span class="op">=</span> <span class="va">n_points</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">xend</span>, length.out <span class="op">=</span> <span class="va">n_points</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">yend</span>, length.out <span class="op">=</span> <span class="va">n_points</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create and return the transformed data frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span> <span class="op">*</span> <span class="va">diameter</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">radians</span><span class="op">)</span> <span class="op">*</span> <span class="va">diameter</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function preserves the logic of the spring code we wrote in <a href="#sec-intuitive-spring" class="quarto-xref"><span>Section 4.1</span></a>, but it does a few new things that matter a lot when writing extensions:</p>
<ul>
<li>It is precise in specifying the parameters that define the spring.</li>
<li>It explicitly checks the input, and uses <code><a href="https://rlang.r-lib.org/reference/abort.html">rlang::abort()</a></code> to throw an error if the user passes an invalid value to the function.</li>
<li>It uses base R functions to do the work: there is no dplyr code in this function because we don’t want our <code>Stat</code> to depend on dplyr.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>
</li>
</ul>
<p>One nice thing about writing <code>create_spring()</code> as a function is that we can test it out<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> to convince ourselves that the logic works:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">spring</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">4</span>, y <span class="op">=</span> <span class="fl">2</span>, xend <span class="op">=</span> <span class="fl">10</span>, yend <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  diameter <span class="op">=</span> <span class="fl">2</span>, tension <span class="op">=</span> <span class="fl">0.6</span>, n <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">spring</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_path</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="creating-the-stat" class="level3" data-number="4.2.2"><h3 data-number="4.2.2" class="anchored" data-anchor-id="creating-the-stat">
<span class="header-section-number">4.2.2</span> Creating the stat</h3>
<p>Now that we have our transformation function, our next task is to encapsulate it into a <code>Stat</code>. To do this, we’ll take what we learned about creating <code>Stat</code> objects in <a href="ggplot2extend.html#sec-new-stats" class="quarto-xref"><span>Section 4.2</span></a> and extend it a little. Our first step is to write some code that creates a subclass of <code>Stat</code> that we’ll call <code>StatSpring</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">StatSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"StatSpring"</span>, <span class="va">Stat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This creates a new <code>Stat</code> subclass named <code>StatSpring</code>. This class doesn’t do anything interesting at this point: the only thing this code does so far is give the class a name.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> To make this useful, we’ll need to specify the methods that will build in the functionality we desire. In <a href="ggplot2extend.html#sec-new-stats" class="quarto-xref"><span>Section 4.2</span></a> we created a <code>Stat</code> by overriding the default method <code>compute_group()</code> and the default field for <code>required_aes</code>,<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> but <code>Stat</code> objects have many properties you can modify . If we print the <code>Stat</code> object, we can see a list of those properties :</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Stat</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class Stat, gg&gt;</span></span>
<span><span class="co">#&gt;     aesthetics: function</span></span>
<span><span class="co">#&gt;     compute_group: function</span></span>
<span><span class="co">#&gt;     compute_layer: function</span></span>
<span><span class="co">#&gt;     compute_panel: function</span></span>
<span><span class="co">#&gt;     default_aes: uneval</span></span>
<span><span class="co">#&gt;     dropped_aes: </span></span>
<span><span class="co">#&gt;     extra_params: na.rm</span></span>
<span><span class="co">#&gt;     finish_layer: function</span></span>
<span><span class="co">#&gt;     non_missing_aes: </span></span>
<span><span class="co">#&gt;     optional_aes: </span></span>
<span><span class="co">#&gt;     parameters: function</span></span>
<span><span class="co">#&gt;     required_aes: </span></span>
<span><span class="co">#&gt;     retransform: TRUE</span></span>
<span><span class="co">#&gt;     setup_data: function</span></span>
<span><span class="co">#&gt;     setup_params: function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can modify almost any of these: the only ones that you shouldn’t touch are <code>aesthetics</code> and <code>parameters</code>, which are intended for internal use only.</p>
<p>For our <code>StatSpring</code> example, the three methods/fields that we’ll need to specify are <code>setup_data()</code>, <code>compute_panel()</code>, and <code>required_aes</code>. We’ll go through this in more detail in the next section, but to help you see what we’re aiming for, here’s the complete code for our stat:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">StatSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"StatSpring"</span>, <span class="va">Stat</span>, </span>
<span>  </span>
<span>  <span class="co"># Edit the input data to ensure the group identifiers are unique</span></span>
<span>  setup_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Construct data for this panel by calling create_spring()</span></span>
<span>  compute_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, </span>
<span>                           <span class="va">scales</span>, </span>
<span>                           <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                           <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, </span>
<span>                           <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>          diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>          tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>          n <span class="op">=</span> <span class="va">n</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Specify which aesthetics are required input</span></span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can print any of these methods with a command such as <code>StatSpring$compute_panel</code> or <code>StatSpring$setup_data</code>.</p>
</section><section id="methods" class="level3" data-number="4.2.3"><h3 data-number="4.2.3" class="anchored" data-anchor-id="methods">
<span class="header-section-number">4.2.3</span> Methods</h3>
<p>Let’s take a closer look at the methods defined for our <code>StatSpring</code>. As discussed in <a href="ggplot2extend.html#sec-new-stats" class="quarto-xref"><span>Section 4.2</span></a> the most important methods for a stat are the three <code>compute_*</code> methods. One of these must always be defined, usually <code>compute_group()</code> or <code>compute_panel()</code>. As a rule of thumb, if the stat operates on multiple rows we start by implementing a <code>compute_group()</code> method, and if the stat operates on single rows we implement a <code>compute_panel()</code> method. Our spring stat is the latter kind: each spring is defined by a single row of the original data, so we’ll use the <code>compute_panel()</code> method which receives all the data for a single panel.</p>
<p>As you can see by looking at source code for our <code>compute_panel()</code> method, we’re doing a bit more than simply calling our <code>create_spring()</code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">scales</span>, <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>        tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>        n <span class="op">=</span> <span class="va">n</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> to loop over each row of the data and create the points required to draw the corresponding spring. For each such spring, we use <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code> to combine the spring data with all the non-position columns of the input row. This is very important, since otherwise the aesthetic mappings to e.g.&nbsp;color and size would be lost. Finally, because the output of <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> is a list of data frames (one per spring), we use <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> to combine these into a single data frame that gets returned.</p>
<p>When defining a new stat, it is very common to specify one or both of the <code>setup_data()</code> and <code>setup_params()</code> methods. These methods are called at the very beginning of the plot building process, so you can use them to do early checks and modifications of the parameters and data.</p>
<p>For our <code>StatSpring</code> example, we use the <code>setup_data()</code> method to ensure that each input row has a unique group aesthetic. This is important because we’re going to draw our springs with <code>GeomPath</code>, and we need to make sure that the data frame output by the stat has a unique identifier for each spring. Doing so ensures that the geom draws each spring as a distinct path, and won’t draw any connecting lines between different springs. Again, there are some subtle details to call attention to in the implementation:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that this implementation preserves the original value of <code>data$group</code>, appending a unique id if needed. This is important because the group aesthetic is sometimes used to carry metadata, and we don’t want to lose that information.</p>
<p>The final part of our new class is the <code>required_aes</code> field. This is a character vector that gives the names of aesthetics that the user <em>must</em> provide to the stat. In this case, we need to make sure the user specifies four position aesthetics: x and y define where the spring starts, while xend and yend define where it ends. The <code>required_aes</code> field, along with <code>default_aes</code> and <code>non_missing_aes</code>, also defines the aesthetics that this stat understands. Any aesthetics that don’t appear in these fields (or in the fields of the corresponding geom) will generate a warning and the mapping will be ignored.</p>
</section><section id="constructors" class="level3" data-number="4.2.4"><h3 data-number="4.2.4" class="anchored" data-anchor-id="constructors">
<span class="header-section-number">4.2.4</span> Constructors</h3>
<p>Now that we have our <code>StatSpring</code> ggproto object, it’s time to write constructor functions that the user will interact with. Strictly speaking we don’t need to do this, because <code>geom_path(stat = "spring")</code> will already work, but it’s good practice to write constructor functions for the convenience of your users. In addition, the constructor function provides a good place to document the new functionality.</p>
<p>Perhaps surprisingly, stat objects are almost always paired with a <code>geom_*()</code> constructor because most ggplot2 users are accustomed to adding geoms, not stats, when building up a plot. The constructor itself is mostly boilerplate code that wraps a call to <code>layer()</code>; just take care to match the argument order and naming used in the ggplot2’s constructors so you don’t surprise your users.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"spring"</span>,</span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                        <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>,</span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                        <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>,</span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>,</span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>,</span>
<span>    geom <span class="op">=</span> <span class="va">GeomPath</span>,</span>
<span>    position <span class="op">=</span> <span class="va">position</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>,</span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      diameter <span class="op">=</span> <span class="va">diameter</span>,</span>
<span>      tension <span class="op">=</span> <span class="va">tension</span>,</span>
<span>      n <span class="op">=</span> <span class="va">n</span>,</span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>,</span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>,</span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>,</span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the sake of completeness you should also create a <code>stat_*()</code> constructor function. There are no surprises here: <code>stat_spring()</code> is very similar to <code>geom_spring()</code> except that it provides a default geom instead of a default stat.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stat_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">geom</span> <span class="op">=</span> <span class="st">"path"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">diameter</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                        <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">StatSpring</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">geom</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>      tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="testing-the-stat" class="level3" data-number="4.2.5"><h3 data-number="4.2.5" class="anchored" data-anchor-id="testing-the-stat">
<span class="header-section-number">4.2.5</span> Testing the stat</h3>
<p>Now that everything is in place, we can test out our new layer:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  yend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">5</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>This looks pretty good. Users can call our <code>geom_spring()</code> constructor function and get sensible results. Better yet, because we’ve written a new stat, we get a number of features for free, like scaling and faceting:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span>, colour <span class="op">=</span> <span class="va">class</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">class</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>Users also have the option of calling the <code>stat_spring()</code> constructor, which can be helpful if for some reason they want to draw the springs with points rather than paths:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">stat_spring</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span>, colour <span class="op">=</span> <span class="va">class</span><span class="op">)</span>,</span>
<span>    geom <span class="op">=</span> <span class="st">"point"</span>, </span>
<span>    n <span class="op">=</span> <span class="fl">15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">class</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section><section id="post-mortem" class="level3" data-number="4.2.6"><h3 data-number="4.2.6" class="anchored" data-anchor-id="post-mortem">
<span class="header-section-number">4.2.6</span> Post-mortem</h3>
<p>We have now successfully created our first extension. It works, but it has some limitations that we now need to think about.</p>
<p>One shortcoming of our implementation is that diameter and tension are constants that can only be set for the full layer. These settings feel more like aesthetics and it would be nice if their values could be mapped to a variable in the data. We’ll discuss solutions to this problem in <a href="#sec-spring2" class="quarto-xref"><span>Section 4.3</span></a> and <a href="#sec-spring3" class="quarto-xref"><span>Section 4.4</span></a>.</p>
</section></section><section id="sec-spring2" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="sec-spring2">
<span class="header-section-number">4.3</span> Part 2: Adding aesthetics</h2>
<p>The stat we created in the last section treats the <code>diameter</code> and <code>tension</code> as constant arguments: they’re not aesthetics and the user can’t map them onto a variable in the data. We can fix this by making a few small changes to the <code>StatSpring</code> code:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">StatSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"StatSpring"</span>, <span class="va">Stat</span>,</span>
<span>                      </span>
<span>  setup_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  compute_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">scales</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">diameter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">tension</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">n</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span>,</span>
<span>  optional_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diameter"</span>, <span class="st">"tension"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main difference with our previous attempt is that the <code>diameter</code> and <code>tension</code> arguments to <code>compute_panel()</code> have gone away, and they’re now taken from the data (just like <code>x</code>, <code>y</code>, etc). This has a downside that we’ll fix in <a href="#sec-spring3" class="quarto-xref"><span>Section 4.4</span></a>: we can no longer set fixed aesthetics. Because of this, we’ll need to remove those arguments from the constructor function:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"spring"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">GeomPath</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>stat_spring()</code> constructor would require the same kind of change.</p>
<p>All that is left is to test our new implementation out:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  yend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">5</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  tension <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>tension <span class="op">=</span> <span class="va">tension</span>, diameter <span class="op">=</span> <span class="va">diameter</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>It appears to work. However, as we expected, it’s no longer possible to set <code>diameter</code> and <code>tension</code> as parameters:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span>diameter <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in geom_spring(diameter = 0.5): Ignoring unknown parameters: `diameter`</span></span>
<span><span class="co">#&gt; Warning: Computation failed in `stat_spring()`</span></span>
<span><span class="co">#&gt; Caused by error in `if (tension &lt;= 0) ...`:</span></span>
<span><span class="co">#&gt; ! argument is of length zero</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<section id="post-mortem-1" class="level3" data-number="4.3.1"><h3 data-number="4.3.1" class="anchored" data-anchor-id="post-mortem-1">
<span class="header-section-number">4.3.1</span> Post-mortem</h3>
<p>In this section we further developed our spring stat so that <code>diameter</code> and <code>tension</code> can be used as aesthetics, varying across springs. Unfortunately, there’s a major downside: these features no longer can be set globally. We’re still also missing a way to control the scaling of the two aesthetics. Fixing both these problems requires the same next step: move our implementation away from <code>Stat</code> and towards a proper <code>Geom</code>.</p>
</section></section><section id="sec-spring3" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="sec-spring3">
<span class="header-section-number">4.4</span> Part 3: A geom</h2>
<p>In many cases a Stat-centred approach is sufficient, for example, many of the graphic primitives provided by the <a href="https://ggforce.data-imaginist.com">ggforce</a> package are Stats. But we need to go further with the spring geom because the <code>tension</code> and <code>diameter</code> aesthetics need to be specified in units that are unrelated to the coordinate system. Consequently, we’ll rewrite our geom to be a proper <code>Geom</code> extension.</p>
<section id="geom-extensions" class="level3" data-number="4.4.1"><h3 data-number="4.4.1" class="anchored" data-anchor-id="geom-extensions">
<span class="header-section-number">4.4.1</span> Geom extensions</h3>
<p>As discussed in <a href="ggplot2extend.html" class="quarto-xref"><span>Chapter 4</span></a>, there are many similarities between <code>Stat</code> and <code>Geom</code> extensions. The biggest difference is that <code>Stat</code> extensions return a modified version of the input data, whereas <code>Geom</code> extensions return graphical objects. In some cases creating a new geom requires you to use the grid package (we’ll cover this in <a href="#sec-spring4" class="quarto-xref"><span>Section 4.6</span></a>), but often you don’t have to.</p>
<p>Much like stat objects, geom objects in ggproto have several methods and fields you can modify. You can see the list by printing the object:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Geom</span></span>
<span><span class="co">#&gt; &lt;ggproto object: Class Geom, gg&gt;</span></span>
<span><span class="co">#&gt;     aesthetics: function</span></span>
<span><span class="co">#&gt;     default_aes: uneval</span></span>
<span><span class="co">#&gt;     draw_group: function</span></span>
<span><span class="co">#&gt;     draw_key: function</span></span>
<span><span class="co">#&gt;     draw_layer: function</span></span>
<span><span class="co">#&gt;     draw_panel: function</span></span>
<span><span class="co">#&gt;     extra_params: na.rm</span></span>
<span><span class="co">#&gt;     handle_na: function</span></span>
<span><span class="co">#&gt;     non_missing_aes: </span></span>
<span><span class="co">#&gt;     optional_aes: </span></span>
<span><span class="co">#&gt;     parameters: function</span></span>
<span><span class="co">#&gt;     rename_size: FALSE</span></span>
<span><span class="co">#&gt;     required_aes: </span></span>
<span><span class="co">#&gt;     setup_data: function</span></span>
<span><span class="co">#&gt;     setup_params: function</span></span>
<span><span class="co">#&gt;     use_defaults: function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="creating-the-geom" class="level3" data-number="4.4.2"><h3 data-number="4.4.2" class="anchored" data-anchor-id="creating-the-geom">
<span class="header-section-number">4.4.2</span> Creating the geom</h3>
<p>In much the same way that a stat uses the <code>compute_layer()</code>, <code>compute_panel()</code>, and <code>compute_group()</code> methods to transform the data, a geom uses <code>draw_layer()</code>, <code>draw_panel()</code>, and <code>draw_group()</code> to create graphical representations of the data. In the same way that we created <code>StatSpring</code> by writing a <code>compute_panel()</code> method to do the heavy lifting, we’ll create <code>GeomSpring</code> by writing a <code>draw_panel()</code> method:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"GeomSpring"</span>, <span class="va">Geom</span>,</span>
<span>  </span>
<span>  <span class="co"># Ensure that each row has a unique group id</span></span>
<span>  setup_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">anyDuplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Transform the data inside the draw_panel() method</span></span>
<span>  draw_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, </span>
<span>                        <span class="va">panel_params</span>, </span>
<span>                        <span class="va">coord</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>, </span>
<span>                        <span class="va">linemitre</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Transform the input data to specify the spring paths</span></span>
<span>    <span class="va">cols_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spring_path</span> <span class="op">&lt;-</span> <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">diameter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">tension</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        <span class="va">n</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">spring_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="va">cols_to_keep</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Use the draw_panel() method from GeomPath to do the drawing</span></span>
<span>    <span class="va">GeomPath</span><span class="op">$</span><span class="fu">draw_panel</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">springs</span>, </span>
<span>      panel_params <span class="op">=</span> <span class="va">panel_params</span>, </span>
<span>      coord <span class="op">=</span> <span class="va">coord</span>, </span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>, </span>
<span>      linemitre <span class="op">=</span> <span class="va">linemitre</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Specify the default and required aesthetics</span></span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span>,</span>
<span>  default_aes <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    linetype <span class="op">=</span> <span class="fl">1L</span>, </span>
<span>    alpha <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    diameter <span class="op">=</span> <span class="fl">1</span>, </span>
<span>    tension <span class="op">=</span> <span class="fl">0.75</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Despite the length of this code, most of it is familiar:</p>
<ul>
<li><p>The <code>setup_data()</code> methods are essentially the same: in both cases they ensure that every row in the input data has a unique group identifier.</p></li>
<li><p>The <code>draw_panel()</code> method for our <code>GeomSpring</code> object is very similar to the <code>compute_panel()</code> method. The main difference is that our <code>draw_panel()</code> method has an extra step: it passes the computed spring coordinates to <code>GeomPath$draw_panel()</code>. Because springs are just fancy paths, the <code>GeomPath$draw_panel()</code> method works perfectly well here.</p></li>
<li><p>Unlike the <code>StatSpring</code> code that we wrote earlier, the <code>GeomSpring</code> code uses the <code>default_aes</code> field to provide default values for any aesthetic that the user does not specify.</p></li>
</ul>
<p>One aspect to this code may surprise developers who are used to object-oriented design from other languages. Calling the method of a kindred object directly, as we do when invoking <code>GeomPath$draw_panel()</code> from within <code>GeomSpring$draw_panel()</code>, is not considered good practice in other object-oriented systems. However, because ggproto objects are stateless (<a href="ggplot2internal.html#sec-ggproto-style" class="quarto-xref"><span>Section 2.4.5</span></a>), this is exactly as safe as subclassing <code>GeomPath</code> and calling the parent method. You can see this approach all over the place in the ggplot2 source code.</p>
</section><section id="a-constructor" class="level3" data-number="4.4.3"><h3 data-number="4.4.3" class="anchored" data-anchor-id="a-constructor">
<span class="header-section-number">4.4.3</span> A constructor</h3>
<p>As with our earlier attempts the final step is to write a constructor function <code>geom_spring()</code>. The code is not much different to earlier versions: we use <code>GeomSpring</code> instead of <code>GeomPath</code>, and we use the identity stat instead of <code>StatSpring</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">arrow</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">linejoin</span> <span class="op">=</span> <span class="st">"round"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">GeomSpring</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      arrow <span class="op">=</span> <span class="va">arrow</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      linejoin <span class="op">=</span> <span class="va">linejoin</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="testing-the-geom" class="level3" data-number="4.4.4"><h3 data-number="4.4.4" class="anchored" data-anchor-id="testing-the-geom">
<span class="header-section-number">4.4.4</span> Testing the geom</h3>
<p>We now have a proper geom with working default aesthetics and the ability to setting aesthetics as parameters:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>tension <span class="op">=</span> <span class="va">tension</span>, diameter <span class="op">=</span> <span class="va">diameter</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span>diameter <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="1200"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid" width="1200"></p>
</div>
</div>
</div>
<p>It does have some limitations still, because the units for <code>diameter</code> and <code>tension</code> are expressed relative to the scale of the raw data. The actual diameter of a spring with <code>diameter = 0.5</code> will be different depending on the axis limits, and if the x and y axes are not on the same scale the shape of the spring will be distorted. You can see this in the example below:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span>, xend <span class="op">=</span> <span class="fl">3</span>, yend <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>The same underlying problem means that the diameter of the spring is expressed in coordinate space. This makes it difficult to define a meaningful default because the absolute size of the spring diameter changes when the scale of the data changes:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span>, xend <span class="op">=</span> <span class="fl">100</span>, yend <span class="op">=</span> <span class="fl">80</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>We’ll address this issue in <a href="#sec-spring4" class="quarto-xref"><span>Section 4.6</span></a>.</p>
</section><section id="post-mortem-2" class="level3" data-number="4.4.5"><h3 data-number="4.4.5" class="anchored" data-anchor-id="post-mortem-2">
<span class="header-section-number">4.4.5</span> Post-mortem</h3>
<p>In this section we finally created our own <code>Geom</code> extension. This is often the natural conclusion to the development of new layer, but not always. Sometimes you’ll find that the <code>Stat</code> approach works perfectly well for your purposes, and it has the advantage that you can use the stat with multiple geoms. The final choice is up to you as the developer, and should be guided by how you expect people to use the layer.</p>
<p>Perhaps surprisingly, we haven’t talked about what goes on inside the <code>draw_*()</code> methods yet. Our <code>GeomSpring</code> object relies on the <code>draw_panel()</code> method from <code>GeomPath</code> to do the work of creating the graphical output. This is quite common. For example, even the relatively complex <a href="https://github.com/tidyverse/ggplot2/blob/master/R/geom-boxplot.r"><code>GeomBoxplot</code></a> just uses the draw methods from <code>GeomPoint()</code>, <code>GeomSegment</code> and <code>GeomCrossbar</code>.</p>
<p>If you need to go deeper, you’ll need to learn a little about grid. Creating grid grobs is an advanced technique, needed by relatively few geoms. But creating a grid grob gives you the power to use absolute units for diameter (e.g.&nbsp;1cm) and to adjust the display of the geom based on the size of the output device. We’ll turn to that next.</p>
</section></section><section id="an-introduction-to-grid" class="level2" data-number="4.5"><h2 data-number="4.5" class="anchored" data-anchor-id="an-introduction-to-grid">
<span class="header-section-number">4.5</span> An introduction to grid</h2>
<p>The grid package provides the underlying graphics system upon which ggplot2 is built. It’s one of two quite different drawing systems that are included in base R: base graphics and grid. Base graphics has an imperative “pen-on-paper” model: every function immediately draws something on the graphics device. Much like ggplot2 itself, grid takes a more declarative approach where you build up a description of the graphic as an object, which is later rendered. This declarative approach allows us to create objects that exists independently of the graphic device and can be passed around, analysed, and modified. Importantly, parts of a graphical object can refer to other parts, which allows you to do things like define this rectangle to have width equal to the length of that string of text, and so on.</p>
<p>As a ggplot2 developer you will find that you can achieve a lot without ever needing to interact with grid directly, but there are situations where it is impossible to achieve what you want without going down to the grid level. The two most common situations are:</p>
<ol type="1">
<li><p>You need to create graphical objects that are positioned correctly on the coordinate system, but where some part of their appearance has a fixed absolute size. In our case this would be the spring correctly going between two points in the plot, but the diameter being defined in cm instead of relative to the coordinate system.</p></li>
<li><p>You need graphical objects that are updated during resizing. This could e.g.&nbsp;be the position of labels such as in the ggrepel package or the <code>geom_mark_*()</code> geoms in ggforce.</p></li>
</ol>
<p>A comprehensive introduction to grid is far more than we can cover in this book, but to help you get started we’ll give you the absolute minimum vocabulary to understand how ggplot2 uses grid. We’ll introduce core concepts like grobs, viewports, graphical parameters, and units but please read <em>R Graphics</em> by <span class="citation" data-cites="murrell:2018">@murrell:2018</span> to get the full details.</p>
<section id="grobs" class="level3" data-number="4.5.1"><h3 data-number="4.5.1" class="anchored" data-anchor-id="grobs">
<span class="header-section-number">4.5.1</span> Grobs</h3>
<p>To understand how grid works, the first thing we need to talk about are <strong>grobs</strong>. Grobs (<strong>gr</strong>aphic <strong>ob</strong>jects) are the atomic representations of graphical elements in grid, and include types like points, lines, circles, rectangles, and text. The grid package provides functions like <code><a href="https://rdrr.io/r/grid/grid.points.html">pointsGrob()</a></code>, <code><a href="https://rdrr.io/r/grid/grid.lines.html">linesGrob()</a></code>, <code><a href="https://rdrr.io/r/grid/grid.circle.html">circleGrob()</a></code>, <code><a href="https://rdrr.io/r/grid/grid.rect.html">rectGrob()</a></code>, and <code><a href="https://rdrr.io/r/grid/grid.text.html">textGrob()</a></code> that create graphical objects without drawing anything to the graphics device. These functions are vectorised, allowing a single point grob to represent multiple points, for instance:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="va">circles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.circle.html">circleGrob</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="fl">0.7</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>  r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">circles</span></span>
<span><span class="co">#&gt; circle[GRID.circle.606]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that this code doesn’t draw anything: it’s just a description of a set of circles. To draw it, we first call <code><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage()</a></code> to clear the current graphics device then <code><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>grid also provides <code><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree()</a></code>, which construct composite objects from multiple atomic grobs. Here’s an illustration:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>  label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"small"</span>, <span class="st">"medium"</span>, <span class="st">"large"</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="fl">0.7</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">composite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">composite</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>It is also possible to define your own grobs. You can define a new primitive grob class using <code><a href="https://rdrr.io/r/grid/grid.grob.html">grob()</a></code> or a new composite class using <code><a href="https://rdrr.io/r/grid/grid.grob.html">gTree()</a></code>, then specify special behaviour for your new class. We’ll see an example of this in a moment.</p>
</section><section id="viewports" class="level3" data-number="4.5.2"><h3 data-number="4.5.2" class="anchored" data-anchor-id="viewports">
<span class="header-section-number">4.5.2</span> Viewports</h3>
<p>The second key concept in grid is the idea of a <strong>viewport</strong>. A viewport is a rectangular plotting region that supplies its own coordinate system for grobs that are drawn within it, and can also provide a tabular grid in which other viewports an be nested. An individual grob can have its own viewport or, if none is provided, it will inherit one. While we won’t need to consider viewports when building the grob for our springs, they’re an important concept that powers much of the high-level layout of ggplot2 graphics so we’ll very briefly introduce them here. In the example below we use <code><a href="https://rdrr.io/r/grid/viewport.html">viewport()</a></code> to define two different viewports, one with default parameters, and second one that is rotated around the midpoint by 15 degrees:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vp_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vp_rotated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This time around, when we create our composite grobs, we’ll explicitly assign them to specific viewports by setting the <code>vp</code> argument:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">composite_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_default</span><span class="op">)</span></span>
<span><span class="va">composite_rotated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_rotated</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we plot these two grobs, we can see the effect of the viewport: although <code>composite_default</code> and <code>composite_rotated</code> are comprised of the same two primitive grobs (i.e., <code>circles</code> and <code>labels</code>), they belong to different viewports so they look different when the plot is drawn:</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">composite_default</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">composite_rotated</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>ggplot2 automatically generates most of the viewports that you’ll need for plotting, but it’s important to understand the basic idea.</p>
</section><section id="graphical-parameters" class="level3" data-number="4.5.3"><h3 data-number="4.5.3" class="anchored" data-anchor-id="graphical-parameters">
<span class="header-section-number">4.5.3</span> Graphical parameters</h3>
<p>The next concept we need to understand is the idea of <strong>graphical parameters</strong>. When we defined the <code>circles</code> and <code>labels</code> grobs, we only specified some of their properties. For example, we said nothing about colour or transparency, so these properties are all set to their default values. The <code><a href="https://rdrr.io/r/grid/gpar.html">gpar()</a></code> function in grid allows you to specify graphical parameters as distinct objects:</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gp_blue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">gp_orange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>gp_blue</code> and <code>gp_orange</code> objects provide lists of graphical settings that can now be applied to any grob we like using the <code>gp</code> argument:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grob1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_default</span>, gp <span class="op">=</span> <span class="va">gp_blue</span><span class="op">)</span></span>
<span><span class="va">grob2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">grobTree</a></span><span class="op">(</span><span class="va">circles</span>, <span class="va">labels</span>, vp <span class="op">=</span> <span class="va">vp_rotated</span>, gp <span class="op">=</span> <span class="va">gp_orange</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we plot these two grobs, they inherit the settings provided by the graphical parameters as well as the viewports to which they are assigned:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">grob1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">grob2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="units" class="level3" data-number="4.5.4"><h3 data-number="4.5.4" class="anchored" data-anchor-id="units">
<span class="header-section-number">4.5.4</span> Units</h3>
<p>The last core concept that we need to discuss is the <strong>unit</strong> system. The grid package allows you to specify the positions (e.g.&nbsp;<code>x</code> and <code>y</code>) and dimensions (e.g.&nbsp;<code>length</code> and <code>width</code>) of grobs and viewports using a flexible specification. In the grid unit system there are three qualitatively different styles of unit:</p>
<ul>
<li>Absolute units, e.g.&nbsp;centimeters, inches, and points, refer to physical sizes.</li>
<li>Relative units e.g.&nbsp;<code>npc</code> which represents a proportion of the current viewport size.</li>
<li>Units defined by strings or other grobs, e.g.&nbsp;<code>strwidth</code>, <code>grobwidth</code>.</li>
</ul>
<p>The <code><a href="https://rdrr.io/r/grid/unit.html">unit()</a></code> function is the main function we use when specifying units: <code>unit(1, "cm")</code> is 1 centimeter, whereas <code>unit(0.5, "npc")</code> is half the size of the relevant viewport. The unit system supports arithmetic operations that are only resolved at draw time, which makes it possible to combine different types of units: <code>unit(0.5, "npc") + unit(1, "cm")</code> defines a point one centimeter to the right of the center of the current viewport.</p>
</section><section id="building-grob-classes" class="level3" data-number="4.5.5"><h3 data-number="4.5.5" class="anchored" data-anchor-id="building-grob-classes">
<span class="header-section-number">4.5.5</span> Building grob classes</h3>
<p>Now that we have a basic understanding of grid, let’s attempt to create our own “surprise” grob class: objects that are circles if they are smaller than 3cm, but transform into squares whenever they are larger than 3cm. This is not the most useful kind of graphical object, but it’s useful for illustrating the flexibility of the grid system. The first step is to write our own constructor function using <code><a href="https://rdrr.io/r/grid/grid.grob.html">grob()</a></code> or <code><a href="https://rdrr.io/r/grid/grid.grob.html">gTree()</a></code>, depending on whether we are creating a primitive or composite object. We begin by creating a “thin” constructor function:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surpriseGrob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                         <span class="va">y</span>, </span>
<span>                         <span class="va">size</span>, </span>
<span>                         <span class="va">default.units</span> <span class="op">=</span> <span class="st">"npc"</span>, </span>
<span>                         <span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                         <span class="va">gp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                         <span class="va">vp</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Ensure that input arguments are units</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Construct the surprise grob subclass as a gTree</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gTree</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    size <span class="op">=</span> <span class="va">size</span>, </span>
<span>    name <span class="op">=</span> <span class="va">name</span>, </span>
<span>    gp <span class="op">=</span> <span class="va">gp</span>, </span>
<span>    vp <span class="op">=</span> <span class="va">vp</span>, </span>
<span>    cl <span class="op">=</span> <span class="st">"surprise"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function doesn’t do very much. All it does is ensure that the <code>x</code>, <code>y</code>, and <code>size</code> arguments are grid units, and sets the class name to be “surprise”. To define the behaviour of our grob, we need to specify methods for one or both of the generic functions <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContext()</a></code> and <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code>:</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/grid/makeContent.html">makeContext()</a></code> is called when the parent grob is rendered and allows you to control the viewport of the grob. We won’t need to use that for our surprise grob.</p></li>
<li><p><code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code> is called every time the drawing region is resized and allows you to customise the look of the grob based on the size or other aspect.</p></li>
</ul>
<p>Because these generic functions use the S3 object oriented programming system, we can define our method simply by appending the class name to the end of the function name. That is, the <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code> method for our surprise grob is defined by creating a function called <code>makeContent.surprise()</code> that takes a grob as input and returns a modified grob as output:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">makeContent.surprise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x_pos</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">x</span></span>
<span>  <span class="va">y_pos</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">size</span>, unitTo <span class="op">=</span> <span class="st">"cm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Figure out if the given sizes are bigger or smaller than 3 cm</span></span>
<span>  <span class="va">circles</span> <span class="op">&lt;-</span> <span class="va">size</span> <span class="op">&lt;</span> <span class="fl">3</span></span>
<span>  </span>
<span>  <span class="co"># Create a circle grob for the small ones</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">circle_grob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.circle.html">circleGrob</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x_pos</span><span class="op">[</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      y <span class="op">=</span> <span class="va">y_pos</span><span class="op">[</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">[</span><span class="va">circles</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">circle_grob</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Create a rect grob for the large ones</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="op">!</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">square_grob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html">rectGrob</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x_pos</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      y <span class="op">=</span> <span class="va">y_pos</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, </span>
<span>      width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">size</span><span class="op">[</span><span class="op">!</span><span class="va">circles</span><span class="op">]</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">square_grob</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Add the circle and rect grob as children of our input grob</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.add.html">setChildren</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gList</a></span><span class="op">(</span><span class="va">circle_grob</span>, <span class="va">square_grob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some of the functions we’ve called here are new, but they all reuse the core concepts that we discussed earlier. Specifically:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth()</a></code> is used to convert grid units from one type to another.</li>
<li>
<code><a href="https://rdrr.io/r/grid/grid.grob.html">gList()</a></code> creates a list of grobs.</li>
<li>
<code><a href="https://rdrr.io/r/grid/grid.add.html">setChildren()</a></code> specifies the grobs that belong to a gTree composite grob.</li>
</ul>
<p>The effect of this function is to ensure that every time the grob is rendered the absolute size of each shape is recalculated. All shapes smaller than 3cm become circles, and all shapes larger than 3cm become squares. To see how this plays out, lets call our new function:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surprises</span> <span class="op">&lt;-</span> <span class="fu">surpriseGrob</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.45</span>, <span class="fl">0.75</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, </span>
<span>  size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>surprises</code> grob contains three shapes whose locations and sizes have been specified relative to the size of the viewport. At this point in time we have no idea which of these shapes will be circles and which will be squares: that depends on the size of the viewport in which the <code>surprises</code> grob is to be drawn. We can now draw the grob in the usual way:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">surprises</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>If you run this code interactively and resize the plotting window you’ll see that the three objects change shape based on the size of the plotting window. This is not the most useful way to employ grid, of course, but hopefully you can see how this technique can be used to do real work.</p>
</section><section id="sec-tabular-grid" class="level3" data-number="4.5.6"><h3 data-number="4.5.6" class="anchored" data-anchor-id="sec-tabular-grid">
<span class="header-section-number">4.5.6</span> Tabular grid</h3>
<p>The last aspect to grid we’ll discuss here is the layout engine provided by the gtable package. It’s not necessary to know about gtable in order to build our spring grob, but there are other kinds of ggplot2 extensions that do require this knowledge, so we’ll give a brief overview here.</p>
<p>As discussed in <a href="ggplot2internal.html#sec-ggplotgtable" class="quarto-xref"><span>Section 2.3</span></a>, when ggplot2 passes the plot to grid for rendering it does so by creating a gtable object with <code>ggplot_gtable()</code>. We can extract this object using the <code>ggplotGrob()</code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">displ</span>, <span class="va">hwy</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">grob_table</span> <span class="op">&lt;-</span> <span class="fu">ggplotGrob</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="va">grob_table</span></span>
<span><span class="co">#&gt; TableGrob (12 x 9) "layout": 18 grobs</span></span>
<span><span class="co">#&gt;     z         cells       name                                          grob</span></span>
<span><span class="co">#&gt; 1   0 ( 1-12, 1- 9) background               rect[plot.background..rect.654]</span></span>
<span><span class="co">#&gt; 2   5 ( 6- 6, 4- 4)     spacer                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 3   7 ( 7- 7, 4- 4)     axis-l           absoluteGrob[GRID.absoluteGrob.642]</span></span>
<span><span class="co">#&gt; 4   3 ( 8- 8, 4- 4)     spacer                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 5   6 ( 6- 6, 5- 5)     axis-t                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 6   1 ( 7- 7, 5- 5)      panel                      gTree[panel-1.gTree.634]</span></span>
<span><span class="co">#&gt; 7   9 ( 8- 8, 5- 5)     axis-b           absoluteGrob[GRID.absoluteGrob.638]</span></span>
<span><span class="co">#&gt; 8   4 ( 6- 6, 6- 6)     spacer                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 9   8 ( 7- 7, 6- 6)     axis-r                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 10  2 ( 8- 8, 6- 6)     spacer                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 11 10 ( 5- 5, 5- 5)     xlab-t                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 12 11 ( 9- 9, 5- 5)     xlab-b titleGrob[axis.title.x.bottom..titleGrob.645]</span></span>
<span><span class="co">#&gt; 13 12 ( 7- 7, 3- 3)     ylab-l   titleGrob[axis.title.y.left..titleGrob.648]</span></span>
<span><span class="co">#&gt; 14 13 ( 7- 7, 7- 7)     ylab-r                                zeroGrob[NULL]</span></span>
<span><span class="co">#&gt; 15 14 ( 4- 4, 5- 5)   subtitle         zeroGrob[plot.subtitle..zeroGrob.650]</span></span>
<span><span class="co">#&gt; 16 15 ( 3- 3, 5- 5)      title            zeroGrob[plot.title..zeroGrob.649]</span></span>
<span><span class="co">#&gt; 17 16 (10-10, 5- 5)    caption          zeroGrob[plot.caption..zeroGrob.652]</span></span>
<span><span class="co">#&gt; 18 17 ( 2- 2, 2- 2)        tag              zeroGrob[plot.tag..zeroGrob.651]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output illustrates how the ggplot2 layout is structured. The plot is comprised of 18 distinct grobs that are arranged in a <code>TableGrob</code> that specifies a 12 x 9 grid, which in turn supplies a collection of viewports within which individual grobs can be drawn. This <code>TableGrob</code> is itself a grobtree, and can be rendered with grid in by calling <code><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">grob_table</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>To illustrate how a <code>TableGrob</code> works, we’ll create a simplified version of this output without using ggplot2. Our first step is to define the constituent grobs that make up our plot:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">xtick</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">8</span></span>
<span><span class="va">ytick</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.points.html">pointsGrob</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">mpg</span><span class="op">$</span><span class="va">displ</span> <span class="op">/</span> <span class="va">xtick</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xtick</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  y <span class="op">=</span> <span class="va">mpg</span><span class="op">$</span><span class="va">hwy</span> <span class="op">/</span> <span class="va">ytick</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ytick</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  default.units <span class="op">=</span> <span class="st">'npc'</span>,</span>
<span>  size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">6</span>, <span class="st">'pt'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">xaxis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.xaxis.html">xaxisGrob</a></span><span class="op">(</span></span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xtick</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  label <span class="op">=</span> <span class="va">xtick</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">yaxis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.yaxis.html">yaxisGrob</a></span><span class="op">(</span></span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ytick</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  label <span class="op">=</span> <span class="va">ytick</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>points</code> grob contains the data to be plotted, while <code>xaxis</code> and <code>yaxis</code> are grobs that draw labelled axes. When we draw the <code>points</code> grob, we get the core of a scatter plot:</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>However, if we want to add axes to this plot, we need a set of viewports laid out in a tabular format so that we can place <code>xaxis</code> immediately below <code>points</code>, and <code>yaxis</code> to the left of <code>points</code>. In ggplot2, this is handled by the gtable layout engine. First, we use <code><a href="https://gtable.r-lib.org/reference/gtable.html">gtable()</a></code> to define the structure:</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gtable.r-lib.org">gtable</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gtable.r-lib.org/reference/gtable.html">gtable</a></span><span class="op">(</span></span>
<span>  widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cm'</span>, <span class="st">'cm'</span>, <span class="st">'null'</span>, <span class="st">'cm'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cm'</span>, <span class="st">'null'</span>, <span class="st">'cm'</span>, <span class="st">'cm'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>plot_layout</code> object is a 4 x 4 <code>TableGrob</code> that defines viewports with sizes that match the row <code>heights</code> and column <code>widths</code> that we passed to <code><a href="https://gtable.r-lib.org/reference/gtable.html">gtable()</a></code>. The <code><a href="https://gtable.r-lib.org/reference/gtable_show_layout.html">gtable_show_layout()</a></code> function provides a convenient way to visualise this layout:</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://gtable.r-lib.org/reference/gtable_show_layout.html">gtable_show_layout</a></span><span class="op">(</span><span class="va">plot_layout</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Notice that this layout has one row with height zero, and one column with width zero. We’ll place the <code>xaxis</code> and <code>yaxis</code> grobs into these rows, and allow them to “spill over” into the adjacent rows and columns that specify the margins for the plot.</p>
<p>To place the grobs into the table, we use the <code><a href="https://gtable.r-lib.org/reference/gtable_add_grob.html">gtable_add_grob()</a></code> function. A <code>TableGrob</code> layout allows an individual grob to span multiple cells using the arguments <code>t</code>, <code>l</code>, <code>b</code>, and <code>r</code> to specify cell indices for the <strong>t</strong>opmost, <strong>l</strong>eftmost, <strong>b</strong>ottom, and <strong>r</strong>ightmost cells spanned by the grob. However, the default is to assume that each grob belongs to exactly one cell, in which case only the <code>t</code> and <code>l</code> arguments need to be specified:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gtable.r-lib.org/reference/gtable_add_grob.html">gtable_add_grob</a></span><span class="op">(</span></span>
<span>  <span class="va">plot_layout</span>,</span>
<span>  grobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">xaxis</span>, <span class="va">yaxis</span><span class="op">)</span>,</span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, <span class="co"># the row defining the top extent of each grob</span></span>
<span>  l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, <span class="co"># the column defining the left extent of each grob</span></span>
<span>  clip <span class="op">=</span> <span class="st">'off'</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we inspect our <code>plot_layout</code> object, we see something that has the same structure as the <code>TableGrob</code> produced by the ggplot2 code above:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_layout</span></span>
<span><span class="co">#&gt; TableGrob (4 x 4) "layout": 3 grobs</span></span>
<span><span class="co">#&gt;   z     cells   name                    grob</span></span>
<span><span class="co">#&gt; 1 1 (2-2,3-3) layout points[GRID.points.655]</span></span>
<span><span class="co">#&gt; 2 2 (3-3,3-3) layout   xaxis[GRID.xaxis.656]</span></span>
<span><span class="co">#&gt; 3 3 (2-2,2-2) layout   yaxis[GRID.yaxis.657]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now draw our plot using <code><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">plot_layout</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Clearly, we’re still missing a lot of important details that would be necessary in a real plot, but hopefully it is now clear how ggplot2 arranges a collection of grobs within a structured plot layout.</p>
</section></section><section id="sec-spring4" class="level2" data-number="4.6"><h2 data-number="4.6" class="anchored" data-anchor-id="sec-spring4">
<span class="header-section-number">4.6</span> Part 4: A grid grob</h2>
<p>Let’s return to the problem at hand. Armed with our new knowledge of the grid system, we can construct a spring grob that specifies the diameter in absolute units.</p>
<section id="the-springgrob" class="level3" data-number="4.6.1"><h3 data-number="4.6.1" class="anchored" data-anchor-id="the-springgrob">
<span class="header-section-number">4.6.1</span> The springGrob</h3>
<p>Let’s start by defining the <code>springGrob()</code> function. Our key insight is that we can write the grob code in a way that pushes the spring drawing action down to the level of the <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code> function. By doing this, we can ensure that the diameter is computed at draw time using absolute units instead of defining the diameter relative to the plot coordinates.</p>
<p>We’ll start by creating our constructor function. The arguments to this function are based on the <code><a href="https://rdrr.io/r/grid/grid.segments.html">segmentsGrob()</a></code> since we are, in essence, drawing modified segments:</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">springGrob</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">y0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">y1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">diameter</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"npc"</span><span class="op">)</span>, </span>
<span>                       <span class="va">tension</span> <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>                       <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                       <span class="va">default.units</span> <span class="op">=</span> <span class="st">"npc"</span>, </span>
<span>                       <span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                       <span class="va">gp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                       <span class="va">vp</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Use the default unit if the user does not specify one</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span><span class="op">)</span> <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span> <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">y0</span><span class="op">)</span><span class="op">)</span> <span class="va">y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">y0</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span><span class="op">)</span> <span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">is.unit</a></span><span class="op">(</span><span class="va">diameter</span><span class="op">)</span><span class="op">)</span> <span class="va">diameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">diameter</span>, <span class="va">default.units</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return a gTree of class "spring"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gTree</a></span><span class="op">(</span></span>
<span>    x0 <span class="op">=</span> <span class="va">x0</span>, </span>
<span>    y0 <span class="op">=</span> <span class="va">y0</span>, </span>
<span>    x1 <span class="op">=</span> <span class="va">x1</span>, </span>
<span>    y1 <span class="op">=</span> <span class="va">y1</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    n <span class="op">=</span> <span class="va">n</span>, </span>
<span>    name <span class="op">=</span> <span class="va">name</span>, </span>
<span>    gp <span class="op">=</span> <span class="va">gp</span>, </span>
<span>    vp <span class="op">=</span> <span class="va">vp</span>, </span>
<span>    cl <span class="op">=</span> <span class="st">"spring"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that once again our constructor is a very thin wrapper around <code><a href="https://rdrr.io/r/grid/grid.grob.html">gTree()</a></code>. It doesn’t introduce any new concepts: all it does is ensure that arguments are converted to units if necessary, and then returns a composite grob with class “spring”. The work of drawing our spring occurs in the <code><a href="https://rdrr.io/r/grid/makeContent.html">makeContent()</a></code> method:</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">makeContent.spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Convert position and diameter values absolute units</span></span>
<span>  <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertX</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x0</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertX</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x1</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertY</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y0</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertY</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y1</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">diameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">diameter</span>, <span class="st">"mm"</span>, valueOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Leave tension and n untouched</span></span>
<span>  <span class="va">tension</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">tension</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">n</span></span>
<span>  </span>
<span>  <span class="co"># Transform the input data to a data frame containing spring paths</span></span>
<span>  <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>      <span class="fu">create_spring</span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">x0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        y <span class="op">=</span> <span class="va">y0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        xend <span class="op">=</span> <span class="va">x1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        yend <span class="op">=</span> <span class="va">y1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        diameter <span class="op">=</span> <span class="va">diameter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        tension <span class="op">=</span> <span class="va">tension</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        n <span class="op">=</span> <span class="va">n</span></span>
<span>      <span class="op">)</span>,</span>
<span>      id <span class="op">=</span> <span class="va">i</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">springs</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Construct the grob</span></span>
<span>  <span class="va">spring_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.lines.html">polylineGrob</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">springs</span><span class="op">$</span><span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">springs</span><span class="op">$</span><span class="va">y</span>, </span>
<span>    id <span class="op">=</span> <span class="va">springs</span><span class="op">$</span><span class="va">id</span>, </span>
<span>    default.units <span class="op">=</span> <span class="st">"mm"</span>, </span>
<span>    gp <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">gp</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.add.html">setChildren</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/grid/grid.grob.html">gList</a></span><span class="op">(</span><span class="va">spring_paths</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again there are a couple of new grid functions here, but hopefully it’s not too hard to work out what they do. In truth there is nothing fancy happening here. Whenever the plot is resized, we grab the coordinates and the diameter settings from the spring grob, and convert them all to millimeters. Only after converting the important quantities to absolute units do we construct the spring paths using the <code>create_spring()</code> function we wrote at the beginning: by pushing the call to <code>create_spring()</code> to this level, we can ensure that the path is defined using absolute units, and then return the result as a polyline grob.</p>
<p>We now have a spring grob suitable for use in ggplot2. In the next section we’ll build a geom around it, but before we do that let’s check that our code behaves as expected:</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">springs</span> <span class="op">&lt;-</span> <span class="fu">springGrob</span><span class="op">(</span></span>
<span>  x0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  y1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>  tension <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">springs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>This looks good, so we can now design our new (and final) geom.</p>
</section><section id="the-last-geomspring" class="level3" data-number="4.6.2"><h3 data-number="4.6.2" class="anchored" data-anchor-id="the-last-geomspring">
<span class="header-section-number">4.6.2</span> The last GeomSpring</h3>
<p>Now that we have a custom grob that draws springs, we can create a <code>GeomSpring</code> ggproto object that uses it. Here’s the complete code for that geom:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomSpring</span> <span class="op">&lt;-</span> <span class="fu">ggproto</span><span class="op">(</span><span class="st">"GeomSpring"</span>, <span class="va">Geom</span>,</span>
<span>  </span>
<span>  <span class="co"># Check that the user has specified sensible parameters                    </span></span>
<span>  setup_params <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"Springs must be defined with `n` greater than 0"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">params</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Check input data and return grobs</span></span>
<span>  draw_panel <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, </span>
<span>                        <span class="va">panel_params</span>, </span>
<span>                        <span class="va">coord</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Remove missing data, returning early if all are missing</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">remove_missing</span><span class="op">(</span></span>
<span>      df <span class="op">=</span> <span class="va">data</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>,</span>
<span>      vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span>, <span class="st">"linetype"</span>, <span class="st">"linewidth"</span><span class="op">)</span>,</span>
<span>      name <span class="op">=</span> <span class="st">"geom_spring"</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">zeroGrob</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Supply the coordinate system for the plot</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">coord</span><span class="op">$</span><span class="fu">is_linear</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">warn</a></span><span class="op">(</span></span>
<span>        <span class="st">"spring geom only works correctly on linear coordinate systems"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">coord</span> <span class="op">&lt;-</span> <span class="va">coord</span><span class="op">$</span><span class="fu">transform</span><span class="op">(</span><span class="va">data</span>, <span class="va">panel_params</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Construct the grob</span></span>
<span>    <span class="fu">springGrob</span><span class="op">(</span></span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">x</span>, </span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">y</span>, </span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">xend</span>, </span>
<span>      <span class="va">coord</span><span class="op">$</span><span class="va">yend</span>,</span>
<span>      default.units <span class="op">=</span> <span class="st">"native"</span>, </span>
<span>      diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">coord</span><span class="op">$</span><span class="va">diameter</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      tension <span class="op">=</span> <span class="va">coord</span><span class="op">$</span><span class="va">tension</span>, </span>
<span>      n <span class="op">=</span> <span class="va">n</span>,</span>
<span>      gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span></span>
<span>        col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="va">coord</span><span class="op">$</span><span class="va">colour</span>, <span class="va">coord</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>        lwd <span class="op">=</span> <span class="va">coord</span><span class="op">$</span><span class="va">linewidth</span> <span class="op">*</span> <span class="va">.pt</span>,</span>
<span>        lty <span class="op">=</span> <span class="va">coord</span><span class="op">$</span><span class="va">linetype</span>,</span>
<span>        lineend <span class="op">=</span> <span class="va">lineend</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  <span class="co"># Specify the default and required aesthetics</span></span>
<span>  required_aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"xend"</span>, <span class="st">"yend"</span><span class="op">)</span>,</span>
<span>  default_aes <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    linetype <span class="op">=</span> <span class="fl">1L</span>, </span>
<span>    alpha <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    diameter <span class="op">=</span> <span class="fl">0.35</span>, </span>
<span>    tension <span class="op">=</span> <span class="fl">0.75</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are a few things to note here. As you might expect, the main changes from the last version are in the <code>draw_panel()</code> method (see below). But there are a couple of other changes.</p>
<ul>
<li><p>Previous versions of <code>GeomSpring</code> – and <code>StatSpring</code> before it – included a <code>setup_data()</code> method that modified the group column in the input data. That’s gone now: we no longer need to worry about this because this new version of the geom doesn’t call <code>create_spring()</code> directly. As far as the geom is concerned, each spring is defined by one (and only one) row in the input data. All the work of “expanding” this to a spring-like path is handled by the grob.</p></li>
<li><p>This version of <code>GeomSpring</code> has a <code>setup_params()</code> method. Its only job is to check the number of points used to define the spring.</p></li>
<li><p>The <code>default_aes</code> field is slightly different. The important change is that we can now set a meaningful default value for <code>diameter</code>.</p></li>
</ul>
<p>Let’s now take a closer look at the new <code>draw_panel()</code> method. Because we are no longer relying on <code>GeomPath$draw_panel()</code> to do the work, we have a few new tasks to take care of:</p>
<ul>
<li><p>It checks to see if the coordinate system is non-linear (e.g.&nbsp;<code>coord_polar()</code>), and if so it emits a warning because our spring grob is not designed to work in that context.</p></li>
<li><p>It uses the coordinate system to rescale the positional aesthetics by calling the <code><a href="https://rdrr.io/r/base/transform.html">transform()</a></code> method for the <code>coord</code> object. This remaps all positional aesthetics to lie between 0 and 1, with 0 being the lowest value visible in our viewport (scale expansions included) and 1 being the highest. With this remapping the coordinates are ready to be passed to the grob.</p></li>
<li><p>We pass a set of graphical parameters to the grob using the grid <code><a href="https://rdrr.io/r/grid/gpar.html">gpar()</a></code> function. Not all grobs care about all entries in <code><a href="https://rdrr.io/r/grid/gpar.html">gpar()</a></code> and since we are constructing a line we only care about the graphical parameters that <code><a href="https://rdrr.io/r/grid/grid.lines.html">polylineGrob()</a></code> understands, namely: <code>col</code> (stroke colour), <code>lwd</code> (line width), <code>lty</code> (line type), <code>lineend</code> (the terminator shape of the line).</p></li>
</ul>
<p>Now that <code>GeomSpring</code> is defined, all that remains is to create a constructor function that the user can call:</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">geom_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapping</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                        <span class="va">stat</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">position</span> <span class="op">=</span> <span class="st">"identity"</span>, </span>
<span>                        <span class="va">...</span>, </span>
<span>                        <span class="va">n</span> <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                        <span class="va">lineend</span> <span class="op">=</span> <span class="st">"butt"</span>, </span>
<span>                        <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                        <span class="va">show.legend</span> <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                        <span class="va">inherit.aes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">layer</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    mapping <span class="op">=</span> <span class="va">mapping</span>, </span>
<span>    stat <span class="op">=</span> <span class="va">stat</span>, </span>
<span>    geom <span class="op">=</span> <span class="va">GeomSpring</span>, </span>
<span>    position <span class="op">=</span> <span class="va">position</span>, </span>
<span>    show.legend <span class="op">=</span> <span class="va">show.legend</span>, </span>
<span>    inherit.aes <span class="op">=</span> <span class="va">inherit.aes</span>, </span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">n</span>, </span>
<span>      lineend <span class="op">=</span> <span class="va">lineend</span>, </span>
<span>      na.rm <span class="op">=</span> <span class="va">na.rm</span>, </span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At long last we can put our new <code>geom_spring()</code> function to good use:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span> <span class="op">*</span> <span class="fl">100</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>As you can see from the output above, we now have springs that behave sensibly when the aspect ratio of the plot changes or when the x and y axes are on different scales. Resizing the plot will trigger a recalculation of the correct path, so it will continue to look as it should.</p>
</section><section id="post-mortem-3" class="level3" data-number="4.6.3"><h3 data-number="4.6.3" class="anchored" data-anchor-id="post-mortem-3">
<span class="header-section-number">4.6.3</span> Post-mortem</h3>
<p>We have finally arrived at the spring geom we set out to make. The diameter aesthetic for our spring has similar behaviour to the linewidth aesthetic, in that it remains fixed when resizing and/or changing the aspect ratio of the plot. There are still improvements we could (and perhaps, should) make. Most notably our <code>create_spring()</code> function remains un-vectorised and needs to be called for each spring separately. Correctly vectorising this function will allow for considerable speed-up when rendering many springs (if that was ever a need). We will leave this as an exercise for the reader.</p>
<p>While the geom is now done, we still have a little work to do. We need to create a diameter scale and provide legend keys that can correctly communicate diameter and tension. This will be the topic of the final section.</p>
</section></section><section id="sec-spring5" class="level2" data-number="4.7"><h2 data-number="4.7" class="anchored" data-anchor-id="sec-spring5">
<span class="header-section-number">4.7</span> Part 5: Scales</h2>
<p>The last step in our process is to define new scales. We want to do this because we have defined two new aesthetics (diameter and tension), and we’d like users to be able to scale them. There’s nothing wrong with defining new aesthetics without providing a scale — which means that the mapped values are passed through unchanged — but if we want users to have some control as well as the possibility of a legend we will need to provide scales for the aesthetics. This is the goal of this final section.</p>
<section id="scaling" class="level3" data-number="4.7.1"><h3 data-number="4.7.1" class="anchored" data-anchor-id="scaling">
<span class="header-section-number">4.7.1</span> Scaling</h3>
<p>Thankfully, compared to the work we’ve done so far, creating new scales is not a huge undertaking. We discussed the basic ideas in <a href="ggplot2extend.html#sec-new-scales" class="quarto-xref"><span>Section 4.5</span></a>, and we can apply those concepts here without too much pain. Our main task is to create a function with the appropriate name that outputs a <code>Scale</code> object. Most scale functions are simple wrappers around one of the three fundamental scale constructor functions, <code>continuous_scale()</code>, <code>discrete_scale()</code>, and <code>binned_scale()</code>. Here’s how we do that for the tension aesthetic:</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_tension_continuous</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">continuous_scale</span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="st">"tension"</span>, </span>
<span>    scale_name <span class="op">=</span> <span class="st">"tension_c"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale_pal.html">rescale_pal</a></span><span class="op">(</span><span class="va">range</span><span class="op">)</span>, </span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This <code>scale_tension_continuous()</code> function indicates which <code>aesthetics</code> it applies to, provides an explicit <code>scale_name</code>, and provides a <code>palette</code> function that transforms the input domain to the output range. All the other arguments that you’d typically expect to see in a scale function, such as <code>name</code>, <code>breaks</code>, <code>limits</code>, get passed down to <code>continuous_scale()</code> with the dots <code>...</code>.<br>
For the tension aesthetic, we expect that users will apply it to continuous scales only, so it’s convenient to define <code>scale_tension()</code> as an alias for <code>scale_tension_continuous()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_tension</span> <span class="op">&lt;-</span> <span class="va">scale_tension_continuous</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, because we don’t want people trying to map the tension aesthetic to discrete data, we’ll also define a <code>scale_tension_discrete()</code> function that always throws an error:</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_tension_discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"Tension cannot be used with discrete data"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The reason this works is that ggplot2 assigns the default scale for aesthetics by searching for a function called <code>scale_&lt;aesthetic-name&gt;_&lt;data-type&gt;</code>, so any time the user maps the tension aesthetic to a discrete variable ggplot2 will find the <code>scale_tension_discrete()</code> function and throw the error. This is also the reason why it is important to include <code>scale_tension_continuous()</code> even when we expect most users will use the <code>scale_tension()</code> alias.</p>
<p>The scale functions for the diameter aesthetic are only slightly more complicated:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scale_diameter_continuous</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, </span>
<span>                                      <span class="va">range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.7</span><span class="op">)</span>, </span>
<span>                                      <span class="va">unit</span> <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">range</span> <span class="op">&lt;-</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html">convertWidth</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">range</span>, <span class="va">unit</span><span class="op">)</span>, </span>
<span>    <span class="st">"cm"</span>, </span>
<span>    valueOnly <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">continuous_scale</span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="st">"diameter"</span>, </span>
<span>    scale_name <span class="op">=</span> <span class="st">"diameter_c"</span>, </span>
<span>    palette <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale_pal.html">rescale_pal</a></span><span class="op">(</span><span class="va">range</span><span class="op">)</span>, </span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">scale_diameter</span> <span class="op">&lt;-</span> <span class="va">scale_diameter_continuous</span></span>
<span><span class="va">scale_tension_discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="st">"Diameter cannot be used with discrete data"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The only change we made from the <code>tension</code> scales is that we allow the user to define which unit the diameter range should be measured in. Since the geom expects centimeters we will convert the range to that before passing it into the scale constructor. In that way the user is free to use whatever absolute unit feels natural to them.</p>
<p>With our scales defined let us have a look:</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_tension</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>From this output we can see that default scales work (i.e., we didn’t add an explicit scale for diameter but the plot renders correctly), as do the custom scales (i.e., we called <code>scale_tension()</code> explicitly).</p>
<p>The output also tells us that our job is not quite done, because the legend isn’t very helpful. The reason for this is that our geom is using the default legend key constructor, <code>draw_key_point()</code>. This function doesn’t understand our new aesthetics, so it ignores them completely. We can fix this by defining a custom legend key function, <code>draw_key_spring()</code>.</p>
</section><section id="draw_key_spring" class="level3" data-number="4.7.2"><h3 data-number="4.7.2" class="anchored" data-anchor-id="draw_key_spring">
<span class="header-section-number">4.7.2</span> draw_key_spring</h3>
<p>Let’s take a look at how a key constructor is written, by inspecting the source code for <code>draw_key_point()</code>. Thankfully, these are pretty simple functions that take a data frame of aesthetic values, and return an appropriate grob that supplies the depictions shown in the legend key:</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draw_key_point</span></span>
<span><span class="co">#&gt; function(data, params, size) {</span></span>
<span><span class="co">#&gt;   if (is.null(data$shape)) {</span></span>
<span><span class="co">#&gt;     data$shape &lt;- 19</span></span>
<span><span class="co">#&gt;   } else if (is.character(data$shape)) {</span></span>
<span><span class="co">#&gt;     data$shape &lt;- translate_shape_string(data$shape)</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   # NULL means the default stroke size, and NA means no stroke.</span></span>
<span><span class="co">#&gt;   stroke_size &lt;- data$stroke %||% 0.5</span></span>
<span><span class="co">#&gt;   stroke_size[is.na(stroke_size)] &lt;- 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   pointsGrob(0.5, 0.5,</span></span>
<span><span class="co">#&gt;     pch = data$shape,</span></span>
<span><span class="co">#&gt;     gp = gpar(</span></span>
<span><span class="co">#&gt;       col = alpha(data$colour %||% "black", data$alpha),</span></span>
<span><span class="co">#&gt;       fill = alpha(data$fill %||% "black", data$alpha),</span></span>
<span><span class="co">#&gt;       fontsize = (data$size %||% 1.5) * .pt + stroke_size * .stroke / 2,</span></span>
<span><span class="co">#&gt;       lwd = stroke_size * .stroke / 2</span></span>
<span><span class="co">#&gt;     )</span></span>
<span><span class="co">#&gt;   )</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x558b1e7e3d70&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:ggplot2&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this code, <code>data</code> is a data frame with a single row giving the aesthetic values to use for the key, <code>params</code> are the geom parameters for the layer, and <code>size</code> is the size of the key area in centimeters. The <code>%||%</code> operator, which you often see in tidyverse source code, is used to supply default values whenever a variable has a null value:</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">`%||%`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="kw">else</span> <span class="va">x</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To define our <code>draw_key_spring()</code> function, we need to create an analogous function that uses <code>springGrob()</code> to draw the key:</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draw_key_spring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">params</span>, <span class="va">size</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">springGrob</span><span class="op">(</span></span>
<span>    x0 <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    y0 <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    x1 <span class="op">=</span> <span class="fl">1</span>, </span>
<span>    y1 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    diameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">diameter</span>, <span class="st">"cm"</span><span class="op">)</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">tension</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span></span>
<span>      col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">colour</span> <span class="op">%||%</span> <span class="st">"black"</span>, <span class="va">data</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>      lwd <span class="op">=</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">size</span> <span class="op">%||%</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">*</span> <span class="va">.pt</span>,</span>
<span>      lty <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">linetype</span> <span class="op">%||%</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"on"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The only part of this code that might be unfamiliar is the little flourish — not strictly necessary — that defines a clipping viewport for our grob using the <code>vp</code> argument. The reason we add this is to ensure the springs drawn in the legend keys will be strictly contained within their boxes and not spill over into the neighboring key areas.</p>
<p>Now that we have this function, all we need to do is tell <code>GeomSpring</code> to use it when drawing the legend key. That’s pretty straightforward: all we have to do is change the <code>draw_key()</code> method of our existing Geom:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GeomSpring</span><span class="op">$</span><span class="va">draw_key</span> <span class="op">&lt;-</span> <span class="va">draw_key_spring</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With that final change our legend is beginning to make sense:</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_tension</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>The default key size is a bit cramped for our key, but that’s something that the user will need to do: ggplot2 doesn’t know about the <code>diameter</code> aesthetic and cannot scale the key size as cleverly as it does with the <code>size</code> aesthetic.</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    tension <span class="op">=</span> <span class="va">tension</span>, </span>
<span>    diameter <span class="op">=</span> <span class="va">diameter</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_tension</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>Conveniently, our new legend key will be used for all scaled aesthetics, not just <code>diameter</code> and <code>tension</code>, thus ensuring that the style of the key will always match the style of the layer:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_spring</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x</span>, </span>
<span>    y <span class="op">=</span> <span class="va">y</span>, </span>
<span>    xend <span class="op">=</span> <span class="va">xend</span>, </span>
<span>    yend <span class="op">=</span> <span class="va">yend</span>, </span>
<span>    colour <span class="op">=</span> <span class="va">class</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="ggplot2_spring_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section><section id="post-mortem-4" class="level3" data-number="4.7.3"><h3 data-number="4.7.3" class="anchored" data-anchor-id="post-mortem-4">
<span class="header-section-number">4.7.3</span> Post-mortem</h3>
<p>This concludes our detailed case study on creating a spring geom. Hopefully it has become clear that there are many different ways to achieve the same geom extension and where you end up is largely guided by your needs and how much energy you want to put into it. The case study focused on layers and (to a lesser extent) scales, but hopefully you can use the simpler examples from <a href="ggplot2extend.html" class="quarto-xref"><span>Chapter 4</span></a> to guide you if you want to explore other types of ggplot2 extensions. You can also study the source code of the facet and coord classes in ggplot2 and the extensions available in ggforce and other packages.</p>


</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>If you have a background in statistics, you’ll recognise this as roughly analogous to how a z-statistic is calculated.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If you have experience developing packages you might wonder about the choice to use <code><a href="https://rlang.r-lib.org/reference/abort.html">rlang::abort()</a></code> rather than using the base <code><a href="https://rdrr.io/r/base/stop.html">stop()</a></code> function. We could certainly have chosen to use the base R function here, but since ggplot2 itself uses the rlang package it makes very little difference in this case.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>If we were planning to bundle this code as an R package, we could expand on this and write formal unit tests for <code>create_spring()</code> using the testthat package.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>By convention ggproto classes always use CamelCase for naming, and the new class is always saved into a variable with the same name.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>As we mentioned earlier, ggproto doesn’t make a strong distinction between methods and fields. <code>Stat</code> objects expect <code>compute_group()</code> to be a function, so we refer to <code>compute_group()</code> as a method because that is the standard terminology in object oriented programming. In contrast, <code>Stat</code> expects <code>required_aes</code> to be a variable, so we call it a field.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/bookr\.stariverfeel\.eu\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../ggplot2/ggplot2extend.html" class="pagination-link" aria-label="编写ggplot2扩展">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">编写ggplot2扩展</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../plot/plot_ex.html" class="pagination-link" aria-label="ggplot2高级绘图示例">
        <span class="nav-page-text">ggplot2高级绘图示例</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>博客<a href="https://blog.stariverfeel.eu.org/">Feel’s Blog</a> | 部署 <a href="https://quarto.org/">Quarto</a>.</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/FeelLiao/RdataVisualization/edit/main/ggplot2/ggplot2_spring.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/FeelLiao/RdataVisualization/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>